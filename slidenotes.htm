<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Slidenote-Editor</title>
<link rel="stylesheet" href="layout.css">
<link rel="stylesheet" href="themes/slidenoteguardian.css">
<script language="javascript" src="slidenotes.js"></script>
<script language="javascript" src="themes/slidenoteguardian.js"></script>
<script language="javascript"><!--
var slidenote;
var slidenoteguardian;
var presentation; //TODO: sollte noch entfernt werden. nur noch slidenote-objekt global
/* = new slidenotes(document.getElementById("quelltext"),
							document.getElementById("texteditorerrorlayer"),
							document.getElementById("wysiwygarea"),
							document.getElementById("fehlercode"),
							document.getElementById("praesentation")
						);
dubbidu
*/

var editorinit=false; //wird nicht mehr gebraucht?

function initeditor(){
	console.log("initeditor:"+editorinit + "slidenote:"+(slidenote==null));
	//console.log(slidenote);
	if(slidenote==null){
		var texted = 		document.getElementById("quelltext");
		var texterr =		 document.getElementById("texteditorerrorlayer");
		var wys = 			document.getElementById("wysiwygarea");
		var errordet =	 document.getElementById("fehlercode");
		var slideshow = 	document.getElementById("praesentation");
		if(texted==null||texterr==null||wys==null||errordet==null||slideshow==null){
			//etwas fehlt noch...
			console.log("etwas fehlt noch")
			setTimeout("initeditor()",500); //gib ihm noch Zeit
		} else{
			slidenote = new slidenotes(texted, texterr, wys, errordet, slideshow );
			presentation = slidenote.presentation;
			//texted.onresize = slidenote.parseneu;
			texted.onresize= function(){slidenote.parseneu();};
			texted.onkeydown= function(event){
				//if(slidenote.wysiwygactivated)slidenote.keypressdown(event, texted); else slidenote.parseneu()
				slidenote.keypressdown(event, texted);
			};
			texted.onkeypress= function(event){if(slidenote.wysiwygactivated)slidenote.keypresswebkit(event, texted);};
			texted.onkeyup=function(event){slidenote.keypressup(event, texted);};
			texted.onpaste=function(){setTimeout('slidenote.parseneu()',150)};
			texted.oncut=function(){setTimeout('slidenote.parseneu()',150)};
			//autofocus tonfocus="initeditor(this.value);
			texted.onscroll=function(){slidenote.scroll(texted);};
			texted.onclick = function(){console.log("parseneu forced by click"+this.selectionEnd);slidenote.parseneu();};
			texted.addEventListener("focusout",function(){console.log("parseneu forced by focus-out");slidenote.parseneu();});
			wys.onmouseup=function(event){slidenote.wysiwyg.copyCursorToTextarea(event); console.log("onmouseupend");};
			wys.onmousedown=function(event){slidenote.wysiwyg.mousedown(event);};
			wys.onpaste=function(event){
				console.log(event.clipboardData.getData('Text'));
				console.log("textareaselstartend:"+slidenote.textarea.selectionStart + "->" +slidenote.textarea.selectionEnd);
				var selstart=slidenote.textarea.selectionStart;
				var selend = slidenote.textarea.selectionEnd;
				var pastetext = event.clipboardData.getData('Text');
				if(!webkit){
					//chromium: does not select textarea, so insert "by hand" (firefox ignores this because it never fires on wysiwyg i think)
					slidenote.textarea.value = slidenote.textarea.value.substring(0,selstart)+
																				pastetext +
																				slidenote.textarea.value.substring(selend);

					setTimeout('slidenote.textarea.focus()',150);
					slidenote.textarea.selectionEnd= selend+pastetext.length;
					slidenote.textarea.selectionStart = slidenote.textarea.selectionEnd;
				}else{
					//webkit-version: just set a new selectionstart/end to select textarea as insert-point
					slidenote.textarea.selectionStart = selstart;
					slidenote.textarea.selectionEnd = selend;

				}
				setTimeout('slidenote.parseneu()',160);
			};
			wys.oncut=function(event){
				if(!webkit){
					//chromium:
					var selstart = slidenote.textarea.selectionStart;
					slidenote.textarea.value = slidenote.textarea.value.substring(0,slidenote.textarea.selectionStart)+
																		slidenote.textarea.value.substring(slidenote.textarea.selectionEnd);

				  slidenote.textarea.selectionEnd = selstart;
					slidenote.textarea.selectionStart = selstart;
					setTimeout('slidenote.textarea.focus()',100);

					setTimeout('slidenote.parseneu()',100);
					//return false;
				}else{
					//webkit: verzöger action weil sonst nichts ins clipboard kopiert wird
					//setTimeout("cutcurrentselection()",200);
					//neu: webkit: selection neu auswählen sorgt bereits für richtige selection
					slidenote.textarea.selectionEnd = slidenote.textarea.selectionEnd;
					slidenote.textarea.selectionStart = slidenote.textarea.selectionStart;
					slidenote.textarea.focus();
					setTimeout('slidenote.parseneu()',200);
				}

			};
			//wys.onkeyup=function(){setTimeout('slidenote.wysiwyg.copyCursorToTextarea()',1);};
			wys.onkeyup=function(event){slidenote.keypressup(event,wys)};
			wys.onkeydown=function(event){slidenote.wysiwyg.shiftkeydown(event);};
			slidenote.parseneu();
			console.log("slidenotes geladen");
			console.log(slidenote);
			texted.addEventListener("focusout", function(){setTimeout("slidenote.wysiwyg.hideorshowcursor()", 100);});
			document.getElementById("praesentationrahmen").onkeyup = function(event){
				//Keyboardsteuerung der Slideshow:
				var key=""+event.key;
				console.log("keycode of pressed key:"+key);
				if(key==="Escape")slidenote.presentation.showpresentation();
				if(key==="ArrowRight" || key===" ")presentation.nextPage();
				if(key==="ArrowLeft")presentation.lastPage();
				if(key==="0" ||key==="1" ||key==="2" ||key==="3" ||key==="4" ||key==="5" ||key==="6" ||key==="7" ||key==="8" ||key==="9" ){
					if(presentation.lastpressednrkey==undefined)presentation.lastpressednrkey="";
					presentation.lastpressednrkey+=key;
				}
				if(key==="Enter"){
					presentation.lastpressednrkey--;
					console.log(presentation.lastpressednrkey);
					presentation.showPage(presentation.lastpressednrkey);
					presentation.lastpressednrkey="";
				}
			};
			slidenoteguardian = new slidenoteGuardian(slidenote);
		}
	}

}
function insertbutton(code){
	if(slidenote!=null)slidenote.insertbutton(code);
}

function parsetesting(){
	var parsetext = slidenote.textarea.value;
	parsetest = false;
	console.log("parse mit parsenachzeilen");
	slidenote.parseneu();
	parsetest = true;
	console.log("parse mit parsemap");
	slidenote.parseneu();
	console.log("parsetest multiply textarea-value by 5");
	for(var x=0;x<5;x++)slidenote.textarea.value += parsetext;
	parsetest = false;
	console.log("parse mit parsenachzeilen");
	slidenote.parseneu();
	parsetest = true;
	console.log("parse mit parsemap");
	slidenote.parseneu();
	console.log("parsetest multiply textarea-value by 10");
	for(var x=0;x<5;x++)slidenote.textarea.value += parsetext;
	parsetest = false;
	console.log("parse mit parsenachzeilen");
	slidenote.parseneu();
	parsetest = true;
	console.log("parse mit parsemap");
	slidenote.parseneu();


}

--></script>
</head>
<body onload="initeditor()">
<div id="slidenotediv">
<!--
	<div id="slidenotebuttons">
		<input type="button" onclick="slidenote.presentation.showpresentation()" value="show presentation">
		<input type="button" onclick="slidenote.showErrorDetails()" value="show parseerrors">
		<input type="button" onclick="document.getElementById('slidenotediv').classList.add('vollbild');document.getElementById('quelltext').focus();" value="wysiwyg-vollbild">
		<select id="editorchoice" onchange="slidenote.choseEditor(this.value)">
			<option value="wysiwyg">WYSIWYM-Editor</option>
			<option value="wysiwygfullscreen">WYSIWYM-Editor Fullscreen</option>
			<option value="md-texteditor" selected>MD-Code Editor</option>
			<option value="wysiwygdebugmode">WYSIWYM-debug mode</option>
		</select>
		<input type="button" onclick="slidenote.presentation.showThemes()" value="Options">
	</div>
-->
	<div id="editorblock">
		<div id="editorheader"><img id="savestatus" src="images/schloss-grau.png" alt="initial state"><span id="notetitle">my awesome slidenote</span> </div>
		<div id="editoroptionbutton"><a href="javascript:slidenote.presentation.showThemes()">Options</a></div>
		<div id="texteditorbuttons">
			<!--<input type="button" onclick="cursorspantest()" value="cursorspantest">-->
			<button onclick="insertbutton('**')" >**bold**</button>
			<button onclick="insertbutton('*')" >*italics*</button>
			<button onclick="insertbutton('~~')" >~~stroke~~</button>
			<button onclick="insertbutton('%head')" >title</button>
			<button onclick="insertbutton('%list')" >unordered list</button>
			<button onclick="insertbutton('%nrlist')" >ordered list</button>
			<button onclick="insertbutton('%quote')" >quote</button>
			<button onclick="insertbutton('%link')" >link</button>
			<button onclick="insertbutton('---')" >new Page</button>
			<!--<button onclick="insertbutton('%image')" >image</button>-->
			<button onclick="insertbutton('%code')" >code</button>
			<!--<button type="button" class="imagebutton" onclick="document.getElementById('imagesblock').classList.add('visible')">image</button>-->
		</div>
		<div id="sidebarcontainer"><div id="sidebar"></div></div>
		<div id="texteditor" class="texteditor">
			<div id="texteditorerrorlayer"></div>
			<textarea spellcheck="false" id="quelltext" onload="" autofocus onfocus="initeditor();"></textarea>
			<div id="texteditorimagespreview"></div>
			<div id="wysiwygarea" contenteditable="true" spellcheck="false"></div>
		</div>
		<div id="footer">
			<button onclick="slidenote.presentation.showpresentation()"><img src="images/presentationtoggle.png"></button>
		</div>
		<div id="imagesblock">
				<h1>Image Upload <button onclick="Javascript:document.getElementById('imagesblock').classList.remove('visible');">close</button></h1>
			<div>
				Select an local image file to upload, then click on image to use it in this slidenote
				<input type="file" id="fileInput">
			</div>
			<div id="imageResizeOptions">
				<input type="radio" name="imageResize" value="1024x768" onchange="slidenote.base64images.changeMaxSize(this.value)"><label>Background/Big (1024x768)</label>
				<input type="radio" name="imageResize" value="400x300" onchange="slidenote.base64images.changeMaxSize(this.value)"><label>Medium (400x300)</label>
				<input type="radio" name="imageResize" value="100x50" onchange="slidenote.base64images.changeMaxSize(this.value)"><label>Icon (100x50)</label>
			</div>
			<div id="filePreview"></div>
			<h1>Files in Database (click on image to reuse)</h1>
			<div id="fileOld"></div>
		</div>

	</div>
	<div id="praesentationrahmen">
		<div id="praesentation"></div>
		<div class="praesentationsteuerung">
				<input type="button" value="last page please" onclick="presentation.lastPage()">
				<input type="button" value="next page please" onclick="presentation.nextPage()">
				<input type="button" onclick="presentation.showpresentation()" value="hide presentation">
		</div>
	</div>
	<div id="options">
		<h1>Options<button id="optionsclose" onclick="slidenote.presentation.hideThemes()" value="close">close</button></h1>
		<div class="tabbar">
			<h2><a href="javascript:slidenote.presentation.optionsTab(0)">Design Options</a></h2>
			<h2><a href="javascript:slidenote.presentation.optionsTab(1)">Global Options</a></h2>
			<h2><a href="javascript:slidenote.presentation.optionsTab(2)">Extensions</a></h2>
		</div>
		<div id="designoptionstab" class="optiontab"></div>
		<div id="globaloptionstab" class="optiontab"></div>
		<div id="themeselectiontab" class="optiontab"></div>
	</div>
	<div id="fehlercoderahmen">
		<div id="fehlercode"></div>
		<input type="button" onclick="this.parentNode.classList.remove('active')" value="close">
	</div>
</div>
<div><h1>Later Hidden Content: CMS-Area</h1>
	<button onclick="slidenoteguardian.saveNote('cms')">save to cms</button>
	<button onclick="slidenoteguardian.loadNote('cms')">load from cms</button>
	<button onclick="slidenoteguardian.saveNote('local')">save local</button>
	<button onclick="slidenoteguardian.loadNote('local')">load local</button>
	<button onclick="slidenoteguardian.saveNote('filesystem')">export as encrypted .slidenote</button>
	<button onclick="slidenoteguardian.exportToFilesystem(slidenote.textarea.value, slidenoteguardian.notetitle+'.md')">export as unencrypted .md textfile</button>
	Import MD-Code or Slidenote: <input type="file" id="importfile">
	<input type="text" id="cmstitle">
	<input type="text" id="cmsslidenotehash">
	<textarea id="cmsarea"></textarea>
	<input type="text" id="cmsimageshash">
	<textarea id="cmsimages" spellcheck="false" autocomplete="false"></textarea>
	<textarea id="cmsconfig"></textarea>
</body>
</html>
